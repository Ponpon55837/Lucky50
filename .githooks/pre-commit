#!/bin/bash

# Lucky50 專案 - Pre-commit Hook
# 防止在受保護分支直接提交代碼，並驗證分支命名規範

# ============================================
# 配置區
# ============================================

# 受保護的分支列表（禁止直接提交）
PROTECTED_BRANCHES=("main" "master" "develop" "staging" "production")

# 允許的分支類型前綴
ALLOWED_TYPES=("feat" "fix" "docs" "style" "refactor" "perf" "test" "chore" "ci" "build" "revert")

# 是否檢查分支命名規範（設為 false 可暫時關閉）
CHECK_BRANCH_NAME=true

# ============================================
# 函數定義
# ============================================

# 顏色定義
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 獲取當前分支名稱
get_current_branch() {
    git symbolic-ref --short HEAD 2>/dev/null || echo "HEAD"
}

# 檢查是否為受保護分支
is_protected_branch() {
    local branch=$1
    for protected in "${PROTECTED_BRANCHES[@]}"; do
        if [ "$branch" = "$protected" ]; then
            return 0  # 是受保護分支
        fi
    done
    return 1  # 不是受保護分支
}

# 驗證分支命名規範
validate_branch_name() {
    local branch=$1
    
    # 格式：<type>/<developer-name>/<description>
    # 範例：feat/lip/add-new-feature
    
    if [[ ! "$branch" =~ ^[a-z]+/[a-z0-9_-]+/[a-z0-9_-]+$ ]]; then
        return 1  # 格式不符
    fi
    
    # 提取類型
    local type=$(echo "$branch" | cut -d'/' -f1)
    
    # 檢查類型是否在允許列表中
    for allowed_type in "${ALLOWED_TYPES[@]}"; do
        if [ "$type" = "$allowed_type" ]; then
            return 0  # 驗證通過
        fi
    done
    
    return 2  # 類型不在允許列表中
}

# 顯示受保護分支錯誤訊息
show_protected_branch_error() {
    local branch=$1
    echo ""
    echo -e "${RED}🚫 =============================================${NC}"
    echo -e "${RED}🚫  錯誤：禁止在 ${branch} 分支直接提交代碼！${NC}"
    echo -e "${RED}🚫 =============================================${NC}"
    echo ""
    echo "根據專案規範，所有代碼修改必須在功能分支上進行。"
    echo ""
    echo -e "${YELLOW}請執行以下步驟：${NC}"
    echo ""
    echo "  1. 建立新的功能分支："
    echo -e "     ${BLUE}git checkout -b <type>/<developer-name>/<feature-description>${NC}"
    echo ""
    echo "  範例："
    echo -e "     ${GREEN}git checkout -b feat/lip/add-new-feature${NC}"
    echo -e "     ${GREEN}git checkout -b fix/lip/fix-bug${NC}"
    echo -e "     ${GREEN}git checkout -b docs/lip/update-readme${NC}"
    echo ""
    echo "  2. 重新提交："
    echo -e "     ${BLUE}git add .${NC}"
    echo -e "     ${BLUE}git commit -m \"你的提交訊息\"${NC}"
    echo ""
    echo "📚 參考文件："
    echo "  - AGENTS.md - 專案規則"
    echo "  - .opencode/skills/git-workflow/SKILL.md - Git 工作流程"
    echo ""
    echo "💡 提示：如果確實需要臨時繞過此檢查（不建議），可使用："
    echo -e "     ${YELLOW}git commit --no-verify${NC}"
    echo ""
}

# 顯示分支命名錯誤訊息
show_branch_name_error() {
    local branch=$1
    local error_code=$2
    
    echo ""
    echo -e "${YELLOW}⚠️  =============================================${NC}"
    echo -e "${YELLOW}⚠️   警告：分支名稱不符合專案規範${NC}"
    echo -e "${YELLOW}⚠️  =============================================${NC}"
    echo ""
    echo -e "${RED}當前分支：${branch}${NC}"
    echo ""
    
    if [ $error_code -eq 1 ]; then
        echo "❌ 錯誤：分支名稱格式不正確"
        echo ""
        echo "📋 正確格式："
        echo -e "   ${BLUE}<type>/<developer-name>/<feature-description>${NC}"
        echo ""
        echo "   各部分說明："
        echo "   - type: 變更類型（feat, fix, docs 等）"
        echo "   - developer-name: 開發者名稱（小寫英文、數字、連字號）"
        echo "   - feature-description: 功能描述（小寫英文、數字、連字號）"
        echo ""
    elif [ $error_code -eq 2 ]; then
        local type=$(echo "$branch" | cut -d'/' -f1)
        echo "❌ 錯誤：不支援的分支類型 '${type}'"
        echo ""
        echo "✅ 允許的分支類型："
        echo "   ${ALLOWED_TYPES[*]}"
        echo ""
    fi
    
    echo "📝 範例："
    echo -e "   ${GREEN}feat/lip/add-user-auth${NC}      - 新增功能"
    echo -e "   ${GREEN}fix/lip/resolve-bug-123${NC}     - 修復問題"
    echo -e "   ${GREEN}docs/lip/update-readme${NC}      - 更新文件"
    echo -e "   ${GREEN}refactor/lip/clean-code${NC}     - 重構代碼"
    echo ""
    echo "🔧 建議動作："
    echo "   1. 重新命名當前分支："
    echo -e "      ${BLUE}git branch -m <正確的分支名稱>${NC}"
    echo ""
    echo "   2. 或建立新分支並切換："
    echo -e "      ${BLUE}git checkout -b <正確的分支名稱>${NC}"
    echo ""
    echo "📚 參考："
    echo "   - .opencode/skills/git-workflow/SKILL.md"
    echo ""
    echo "💡 注意：此為警告訊息，不會阻止提交。"
    echo "   但強烈建議遵循命名規範以保持專案一致性。"
    echo ""
}

# ============================================
# 主要邏輯
# ============================================

# 獲取當前分支
CURRENT_BRANCH=$(get_current_branch)

# 檢查 1: 是否為受保護分支
if is_protected_branch "$CURRENT_BRANCH"; then
    show_protected_branch_error "$CURRENT_BRANCH"
    exit 1
fi

# 檢查 2: 驗證分支命名規範（僅警告，不阻止提交）
if [ "$CHECK_BRANCH_NAME" = true ]; then
    validate_branch_name "$CURRENT_BRANCH"
    VALIDATION_RESULT=$?
    
    if [ $VALIDATION_RESULT -ne 0 ]; then
        show_branch_name_error "$CURRENT_BRANCH" "$VALIDATION_RESULT"
        # 注意：這裡只顯示警告，不退出（return 0）
        # 如果要強制執行命名規範，將下面這行取消註解：
        # exit 1
    fi
fi

# 所有檢查通過，允許提交
exit 0
